name: Create Islamic Story Video

on:
  # Manual trigger with options
  workflow_dispatch:
    inputs:
      topic:
        description: 'Story topic'
        required: false
        type: choice
        options:
          - random
          - prophets
          - sahaba
          - moral_lessons
          - quran_stories
        default: 'random'
      theme:
        description: 'Story theme (optional)'
        required: false
        type: string
      upload_to_youtube:
        description: 'Upload to YouTube?'
        required: false
        type: boolean
        default: false

concurrency:
  group: video-creation
  cancel-in-progress: false

jobs:
  create-video:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg imagemagick fonts-noto fonts-noto-cjk fonts-freefont-ttf
          # Configure ImageMagick to allow PDF/font operations
          sudo sed -i 's/rights="none" pattern="PDF"/rights="read|write" pattern="PDF"/' /etc/ImageMagick-6/policy.xml || true
          # Also fix ImageMagick policy for text rendering
          sudo sed -i 's/rights="none" pattern="@\*"/rights="read|write" pattern="@*"/' /etc/ImageMagick-6/policy.xml || true
      
      - name: Install Python dependencies
        run: |
          pip install -r requirements.txt
      
      - name: Create .env file from secrets
        env:
          ANTHROPIC_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MDL: ${{ secrets.ANTHROPIC_MODEL }}
          ELEVENLABS_KEY: ${{ secrets.ELEVENLABS_API_KEY }}
          PEXELS_KEY: ${{ secrets.PEXELS_API_KEY }}
        run: |
          # Mask secrets so they never appear in logs
          echo "::add-mask::$ANTHROPIC_KEY"
          echo "::add-mask::$ELEVENLABS_KEY"
          echo "::add-mask::$PEXELS_KEY"
          {
            printf 'ANTHROPIC_API_KEY=%s\n' "$ANTHROPIC_KEY"
            printf 'ANTHROPIC_MODEL=%s\n' "$ANTHROPIC_MDL"
            printf 'ELEVENLABS_API_KEY=%s\n' "$ELEVENLABS_KEY"
            printf 'PEXELS_API_KEY=%s\n' "$PEXELS_KEY"
            printf 'YOUTUBE_CLIENT_SECRETS=config/youtube-client-secrets.json\n'
          } > config/.env
      
      - name: Create YouTube credentials file (if secrets exist)
        env:
          YOUTUBE_SECRETS: ${{ secrets.YOUTUBE_CLIENT_SECRETS }}
          YOUTUBE_TOKEN_VAL: ${{ secrets.YOUTUBE_TOKEN }}
        if: ${{ env.YOUTUBE_SECRETS != '' }}
        run: |
          printf '%s' "$YOUTUBE_SECRETS" > config/youtube-client-secrets.json
          # Also create token file if it exists
          if [ -n "$YOUTUBE_TOKEN_VAL" ]; then
            printf '%s' "$YOUTUBE_TOKEN_VAL" > config/youtube_token.json
          fi
      
      - name: Create video
        id: create_video
        env:
          INPUT_TOPIC: ${{ github.event.inputs.topic }}
          INPUT_THEME: ${{ github.event.inputs.theme }}
          INPUT_UPLOAD: ${{ github.event.inputs.upload_to_youtube }}
        run: |
          # Build command safely using array (prevents shell injection)
          declare -a CMD=("python3" "main.py")

          # Add topic if specified
          if [ "$INPUT_TOPIC" != "random" ] && [ -n "$INPUT_TOPIC" ]; then
            CMD+=("--topic" "$INPUT_TOPIC")
          fi

          # Add theme if specified
          if [ -n "$INPUT_THEME" ]; then
            CMD+=("--theme" "$INPUT_THEME")
          fi

          # Add upload flag
          if [ "$INPUT_UPLOAD" != "true" ]; then
            CMD+=("--dry-run")
          fi

          # Run command safely
          echo "Running: ${CMD[*]}"
          "${CMD[@]}" 2>&1 | tee /tmp/video_output.log
          EXIT_CODE=${PIPESTATUS[0]}

          if [ $EXIT_CODE -ne 0 ]; then
            echo "::error title=Video Creation Failed::Pipeline exited with code $EXIT_CODE. Check logs for details."
            echo "--- Last 20 lines of output ---"
            tail -20 /tmp/video_output.log
            exit $EXIT_CODE
          fi

          # Get the latest video file
          VIDEO_FILE=$(ls -t assets/output/*.mp4 2>/dev/null | head -1)
          if [ -n "$VIDEO_FILE" ]; then
            echo "video_file=$VIDEO_FILE" >> $GITHUB_OUTPUT
            echo "Created video: $VIDEO_FILE"
          else
            echo "::error title=No Video File::Pipeline completed but no .mp4 file was found in assets/output/"
            exit 1
          fi
      
      - name: Upload video as artifact
        uses: actions/upload-artifact@v4
        with:
          name: islamic-story-video-${{ github.run_number }}
          path: |
            assets/output/*.mp4
            assets/audio/*.mp3
          retention-days: 7
      
      - name: Report result
        if: always()
        run: |
          if [ "${{ steps.create_video.outcome }}" == "success" ]; then
            echo "::notice title=Video Created::Video successfully created and uploaded as artifact!"
            echo "::notice title=Download::Go to the Actions tab to download your video"
          else
            echo "::error title=Pipeline Failed::Video creation failed. Check the 'Create video' step logs for details."
          fi
